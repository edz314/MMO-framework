-- Define the NPC object
NPC = {
    speed = 2,  -- Units per second
    position = {x = 0, y = 0},
    retreat_point = {x = -10, y = -10},  -- Safe location to retreat to
    health_threshold = 30,  -- Health level below which the NPC retreats
    health = 100,  -- Current health of the NPC
    target = nil,
}

-- Function to calculate the distance between two points
function calculate_distance(point1, point2)
    local dx = point2.x - point1.x
    local dy = point2.y - point1.y
    return math.sqrt(dx * dx + dy * dy)
end

-- Function to move NPC towards a specific point
function move_towards_point(target_point, speed)
    -- Calculate the direction vector towards the target point
    local direction = {
        x = target_point.x - NPC.position.x,
        y = target_point.y - NPC.position.y
    }

    -- Normalize the direction vector
    local magnitude = calculate_distance(NPC.position, target_point)
    direction.x = direction.x / magnitude
    direction.y = direction.y / magnitude

    -- Move the NPC in the direction of the target point
    NPC.position.x = NPC.position.x + direction.x * speed
    NPC.position.y = NPC.position.y + direction.y * speed
end

-- Retreat action function
function retreat_action()
    -- Check if the NPC's health is below the threshold
    if NPC.health <= NPC.health_threshold then
        -- Move towards the retreat point
        move_towards_point(NPC.retreat_point, NPC.speed)
        print("Retreating to safe point. Current position: (" .. NPC.position.x .. ", " .. NPC.position.y .. ")")
    else
        -- If health is above the threshold, no retreat needed
        print("Health is sufficient, no need to retreat.")
    end
end

-- Example usage:
-- Assign a target to the NPC (though it's not used directly in this script)
NPC.target = { position = {x = 5, y = 5} }

-- Reduce the NPC's health to trigger a retreat
NPC.health = 25

-- Execute the retreat action
retreat_action()

-- Output the NPC's position after retreating
print("NPC's position after retreat: (" .. NPC.position.x .. ", " .. NPC.position.y .. ")")
